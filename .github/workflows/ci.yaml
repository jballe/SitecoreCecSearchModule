name: CI

on:
  push:
  workflow_dispatch:

permissions:
   # This is required to create releases
  contents: write
  # Allow cancel job
  actions: write
  # Allow create new deployments
  deployments: write
  # Allow upload package
  packages: write


jobs:
  build:
    name: Build
    uses: ./.github/workflows/sub_version.yaml

  verify:
    name: Verify
    uses: ./.github/workflows/sub_verify.yaml

  publish_beta:
    name: Prerelease
    needs:
      - build
      - verify
    uses: ./.github/workflows/sub_publish_prerelease.yaml
    with:
      version: ${{ needs.build.outputs.version }}
      version_primary: ${{ needs.build.outputs.version_primary }}
      version_prerelease: ${{ needs.build.outputs.version_prerelease }}
    secrets: inherit

  publish_rc:
    name: Release candidate
    if: github.ref == 'refs/heads/main'
    needs:
      - build
      - publish_beta
    uses: ./.github/workflows/sub_publish_release.yaml
    with:
      version: ${{ needs.build.outputs.version }}
      version_primary: ${{ needs.build.outputs.version_primary }}
      version_prerelease: ${{ needs.build.outputs.version_prerelease }}
      environment_name: psgallery
    secrets: inherit

  publish_release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build
      - publish_beta
    uses: ./.github/workflows/sub_publish_release.yaml
    with:
      version: ${{ needs.build.outputs.version }}
      version_primary: ${{ needs.build.outputs.version_primary }}
      version_prerelease: ${{ needs.build.outputs.version_prerelease }}
      environment_name: psgallery_release
    secrets: inherit

  github_release_rc:
    name: GitHub Release
    if: github.ref == 'refs/heads/main'
    needs:
      - build
      - publish_rc
    uses: ./.github/workflows/sub_github_release.yaml
    with:
      version: ${{ needs.build.outputs.version }}
      version_prerelease: ${{ needs.build.outputs.version_prerelease }}
    secrets: inherit
  
  github_release:
    name: GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build
      - publish_release
    uses: ./.github/workflows/sub_github_release.yaml
    with:
      version: ${{ needs.build.outputs.version }}
      version_prerelease: ${{ needs.build.outputs.version_prerelease }}
    secrets: inherit
  
  