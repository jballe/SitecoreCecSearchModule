name: Sub Publish Release

on:
  workflow_call:

jobs:
  publish:
    name: Publish Release to PSGallery
    runs-on: ubuntu-latest
    environment:
      name: psgallery
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: GitVersion install
      shell: pwsh
      run: |
        dotnet tool install --global GitVersion.Tool --version 5.*

    - name: Update version
      shell: pwsh
      id: version
      run: |
        $versions = dotnet-gitversion /config .\bld\GitVersion.yml /output json | Out-String | ConvertFrom-Json
        Write-Host "GitVersion output"
        $versions

        $no = $versions.CommitsSinceVersionSourcePadded
        $version = $versions.MajorMinorPatch
        $prerelease = ("{0}" -f $versions.NuGetPreReleaseTagV2)
        $branch = $versions.PreReleaseLabel

        If("${{github.ref_name }}" -match "refs/pull/([0-9]+)/merge") {
          $pr = $Matches[1]
          $prerelease = "alpha${pr}pr${no}"
        } ElseIf("$branch" -ne "main") {
          $prerelease = "beta${branch}${no}"
        } ElseIf ("$branch" -eq "main" -and "${prerelease}" -eq "") {
          $prerelease = "rc${no}"
        }

        $fullversion = (@($version, $prerelease) | Where-object { $_ -ne "" }) -join "-"

        echo ("version={0}" -f $version) >> "$env:GITHUB_OUTPUT"
        echo ("prerelease={0}" -f $prerelease) >> "$env:GITHUB_OUTPUT"
        echo ("full_version={0}" -f $fullversion) >> "$env:GITHUB_OUTPUT"
        echo ("is_prerelease={0}" -f ("${prerelease}" -ne "")) >> "$env:GITHUB_OUTPUT"

        $versionParams = @{
          Path = "./src/SitecoreCecSearchModule/SitecoreCecSearchModule.psd1"
          ModuleVersion = $version
        }
        if("${prerelease}" -ne "") {
          $versionParams.Prerelease = $prerelease
        }

        Write-Host ("Update version to {0}" -f $fullversion)
        Update-ModuleManifest @versionParams

    - name: Publish
      shell: pwsh
      env:
        NUGETKEY: ${{ secrets.NUGET_APIKEY }}
      run: |
        Publish-Module -path ./src/SitecoreCecSearchModule -NuGetApiKey "${env:NUGETKEY}" -Verbose -AllowPrerelease

    - name: Create github release tag
      if: success() && github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.full_version }}
        release_name: Release v${{ steps.version.outputs.full_version }}
        draft: true
        prerelease: ${{ steps.version.outputs.is_prerelease != 'false' }}
